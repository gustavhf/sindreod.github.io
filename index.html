<!DOCTYPE html>
<html>
<head> 
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="lib/leaflet.css"/>
    <script src="js/sidenav.js"></script>
    <script src="js/fileLoad.js"></script>
    <script src="js/mapOperations.js"></script>


    <!-- Lib libraries -->
    <script src="lib/leaflet.js"></script> <!-- Leaflet osv basemap -->
    <script src="lib/leaflet.ajax.min.js"></script> <!-- Read external GeoJSON-files -->
    <script src="lib/jquery-3.3.1.min.js"></script> <!-- jQuery API -->
    <script src="lib/Sortable.min.js"></script> <!-- Sortable extension -->
    <script src="lib/turf.min.js"></script> <!-- Turf -->
    <script src="js/leafletExtension.js"></script> <!-- Leaflet extension -->
    <link rel="stylesheet" href="index.css"/>
    <link rel="stylesheet" href="lib/tabMenu.css"/>
    <link rel="stylesheet" href="lib/stylesheet.css">
    <link rel="icon" href="pika.png">
</head>

<body>
<!-- Side navigation -->
<div class="sidenav">
    <img src="PokeGIS.png" alt="PokéGIS">
    <!-- Tab links -->
    <div id = "cssmenu" class="tab">
        <ul>
            <li id="defaultOpen" class="tablinks" onclick="openTab(event, 'Operations')"><a href="#">Operations</a></li>
            <li class="tablinks" onclick="openTab(event, 'Layers')"><a href="#">Layers</a></li>
            <li class="tablinks" onclick="openTab(event, 'Story')"><a href="#">Story</a></li>
        </ul>
    </div>

    <div id="Operations" class="tabcontent">
        <ul>
            <li>
                <div id="buffer" class="dropDown">Buffer</div>
                <div class="dropDownContent">
                    <span class="dropDownLeft">Layergroup:</span>
                    <select id="bufferLayerGroup" name="bufferSelect1" class="dropDownLayers dropDownLayerGroup" required>
                        <!-- Options here -->
                    </select>
                    <span class="dropDownLeft">Distance:</span>
                    <input name="bufferDistance" id="bufferDistance" type="number" placeholder="km">
                    <button id="createBuffer"
                            onclick="createBuffer('bufferLayerGroup','bufferDistance')">
                        Create buffer
                    </button>
                </div>
            </li>
            <li>
                <div id="Union" class="dropDown">Union</div>
                <div class="dropDownContent">
                    <span class="dropDownLeft">Layer1:</span>
                    <select id="unionLayerGroup1" name="unionSelect1" class="dropDownLayers dropDownLayerGroup" required>
                        <!-- Options here -->
                    </select>
                    <span class="dropDownLeft">Layer2:</span>
                    <select id="unionLayerGroup2" name="unionSelect2" class="dropDownLayers dropDownLayerGroup" required>
                        <!-- Options here -->
                    </select>
                    <button id="createUnion"
                        onclick="createUnion('unionLayerGroup1','unionLayerGroup2')">
                        Create union
                    </button>
                </div>
            </li>
            <li>
                <div id="Intersection" class="dropDown">Intersection</div>
                <div class="dropDownContent">
                    <span class="dropDownLeft">Layer1:</span>
                    <select id="intersectionLayerGroup1" name="intersectionSelect1" class="dropDownLayers dropDownLayerGroup" required>
                        <!-- Options here -->
                    </select>
                    <span class="dropDownLeft">Layer2:</span>
                    <select id="intersectionLayerGroup2" name="intersectionSelect2" class="dropDownLayers dropDownLayerGroup" required>
                        <!-- Options here -->
                    </select>
                    <button id="createIntersection"
                            onclick="createIntersection('intersectionLayerGroup1','intersectionLayerGroup2')">
                        Create intersection
                    </button>
                </div>

            </li>
            <li>
                <div id="Difference" class="dropDown">Difference</div>
                <div class="dropDownContent">
                    <span class="dropDownLeft">Layer:</span>
                    <select id="differenceLayerGroup1" name="differenceSelect1" class="dropDownLayers dropDownLayerGroup" required>
                        <!-- Options here -->
                    </select>
                    <span class="dropDownLeft">Diff. layer:</span>
                    <select id="differenceLayerGroup2" name="differenceSelect2" class="dropDownLayers dropDownLayerGroup" required>
                        <!-- Options here -->
                    </select>
                    <button id="createDifference"
                            onclick="createDifference('differenceLayerGroup1','differenceLayerGroup2')">
                        Create difference
                    </button>
                </div>

            </li>
            <li>
                <div id="Filter" class="dropDown">Filter</div>
                <div class="dropDownContent" id="filterDiv">
                    <span class="dropDownLeft">Layer:</span>
                    <select id="filterLayerGroup" class="dropDownLayers dropDownLayerGroup" required
                            onchange="updateFilterSelect('filterSelect','filterLayerGroup')">
                        <!-- Options here -->
                    </select>
                    <select id="filterSelect" required
                            onchange="updateFilterValue('filterDiv','filterLayerGroup','filterSelect')">
                        <!-- Options here -->
                    </select>
                    <select id="filterSign" required>
                        <!-- Option signs -->
                    </select>
                    <br id="break">
                    <button id="createFilter"
                            onclick="createFilter('filterLayerGroup','filterSelect','filterSign','filterValues')">
                        Extract features
                    </button>

                </div>
            </li>
            <li>
                <div style="border-bottom: 3px solid #FFCB05"></div>
            </li>
        </ul>
    </div>

    <div id="Layers" class="tabcontent">
        <ul>
            <li>
                <div id="importHeader" class="dropDown">Import</div>
                <div class="dropDownContent">
                    <input id="fileImport" type="file" accept=".geojson" multiple>
                    <button id="import">Import geojson to map</button>
                </div>
            </li>
            <li>
                <div id="exportHeader" class="dropDown">Export</div>
                <div class="dropDownContent">
                    Layer:
                    <select id="exportSelect" class="dropDownLayers dropDownLayerGroup" required
                    <!-- Options here -->
                    </select>
                    <button id="export">Export layer to geojson</button>
                </div>
            </li>
        </ul>
        <div style="border-bottom: 3px solid #FFCB05"></div>
        <output id="import_list"></output>
        <div style="border-bottom: 3px solid #FFCB05"></div>

    </div>
    <div id="Story" class="tabcontent">
        <ul>
            <li>
                <div class="dropDown storyHeader story1">Story 1: The Basics</div>
                <div class="dropDownContent story1parent">
                    <div style="display: none" class="s1_1">
                        <h4>Hello there! Welcome to the world of pokémon. My name is Oak! People call me the pokémon Prof! This world is inhabited by creatures called pokémon! For some people, pokémon are pets. Others use them for fights. Myself...I study pokémon as a profession using GIS-tools to master it. <br><br> First we will have a look at the basics of GIS.</h4>
                        <button class="story_button next_button" style="float: right">Next Page</button>
                        <button class="story_button menu_button" style="float: right">Close Page</button>
                    </div>
                    <div style="display: none" class="s1_2">
                        <h4>Maps consist of different layers. Each layer can take up different forms; points, lines and polygons. <br><br> Now you will learn a little about each type of layer.</h4>
                        <img src="points.png" style="width: 230px; padding:0; margin: 0 27px 0 27px">
                        <button class="story_button previous_button">Prev Page</button>
                        <button class="story_button menu_button">Close Page</button>
                        <button class="story_button next_button">Next Page</button>
                    </div>
                    <div style="display: none" class="s1_3">
                        <h4>Now, you can see a point layer is added to the map. This layer represents xxx.</h4>
                        <button class="story_button previous_button">Prev Page</button>
                        <button class="story_button menu_button">Close Page</button>
                        <button class="story_button next_button">Next Page</button>
                    </div>
                    <div style="display: none" class="s1_4">
                        <button class="story_button previous_button">Prev Page</button>
                        <button class="story_button menu_button">Close Page</button>
                    </div>
                </div>
            </li>
            <li>
                <div class="dropDown storyHeader story2">Story2</div>
                <div class="dropDownContent">
                    <div style="display: none" class="s2_1 locked">
                        <h4>Hello there! Welcome to the world of pokémon. My name is Oak! People call me the pokémon Prof! This world is inhabited by creatures called pokémon! For some people, pokémon are pets. Others use them for fights. Myself...I study pokémon as a profession using GIS-tools to master it. <br><br> First we will have a look at the basics of GIS.</h4>
                        <button class="story_button next_button s0_button1" style="float: right">Next Page</button>
                        <button class="story_button menu_button" style="float: right">Close Page</button>
                    </div>
                </div>
            </li>
            <li>
                <div class="dropDown storyHeader">Story3</div>
                <div class="dropDownContent">

                </div>

            </li>
            <li>
                <div class="dropDown storyHeader">Story4</div>
                <div class="dropDownContent">

                </div>

            </li>
            <li>
                <div class="dropDown storyHeader">Story5</div>
                <div class="dropDownContent"></div>
            </li>
            <li>
                <div style="border-bottom: 3px solid #FFCB05"></div>
            </li>
        </ul>
        <button id="reset">Reset stories</button>
    </div>

</div>

<!-- Page content -->
<div class="main">
    <div id="map"></div>
</div>
 <script type="text/javascript">

     document.getElementById("defaultOpen").click();

     myStorage = window.localStorage;
     if(! myStorage.getItem('storyIndex')) {
         myStorage.setItem('storyIndex', 0);
     }

     var storyIndex = myStorage.getItem('storyIndex');
     // Set background map
     var map = L.map('map', {
         drawControl: true,
         minZoom: 11,
         maxZoom: 20
     }).setView([63.366288, 10.4308315]);

     //Set bounds for startup
     var startBounds = L.latLngBounds([
         [63.381063, 10.393066],
         [63.351513, 10.468597]
     ]);

     //Set bounds for panning
     var worldBounds = L.latLngBounds([
         [63.430860, 10.055237],
         [63.171095, 10.784454]
     ]);

     //Start and panning bounds applied
     map.fitBounds(startBounds);
     map.on('drag', function() {
         map.panInsideBounds(worldBounds, { animate: true });
     });

     lastZoom = map.getZoom();
     //Add baseMap layer to map and display it
     var backGroundLayer = L.layerGroup().addTo(map);

     var baseLayer = {
         "Pokemon World": backGroundLayer
     };

     var overlay = {};

     var controls = L.control.layers(baseLayer, overlay, {collapsed:false}).addTo(map);

     //Add a region layer to map
     var politicalLayer = L.layerGroup();

     //Make a region dictionary and collect in featureGroups
     var regions = {};
     regionNames = ["Hoenn", "Sinnoh", "Orange Islands", "Orre", "Johto", "Kanto", "Sevii Islands", "Fiore", "Oblivia", "Almia", "Holon", "Unova", "Distant land", "Rest"];
     for (var i = 0; i < regionNames.length; i++) {
         regions[regionNames[i]] = L.featureGroup();
         politicalLayer.addLayer(regions[regionNames[i]]);
     }

     //Make a layer for all cities on the map
     var cityLayer = L.layerGroup();

     var cities = {};

     //Add hightlighting on hover
     politicalLayer.eachLayer(function (layer) {
        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight
        });
     });


     loadBackgroundData();
     loadOverlayData();

     controls.addOverlay(politicalLayer, "Geographical region");
     controls.addOverlay(cityLayer, "Cities");

     updateLayerGroup();

     addDropdown();

     function getPokeball(pop) {
         var size = Math.pow(Math.E, 0.57*(Math.log(pop)-Math.log(0.1))) < 10 ? 10 : Math.pow(Math.E, 0.57*(Math.log(pop)-Math.log(0.1)));
         if (size < 200) {
             return "<img src=pokeball.png width=" + size + " height=" + size + " style: {margin: 10px}>";
         } else {
             return "<img src=pokeball.png width=10 height=10 style: {margin: 10px}>";
         }
     }

     var cityLegend = L.control({position: 'bottomright'});

     cityLegend.onAdd = function(map) {
         var div = L.DomUtil.create('div', 'info legend'),
             pop = [25, 50, 75, 100],
             labels = [];

         div.innerHTML += "<strong>Population: </strong><br><br>";
         // loop through our density intervals and generate a icon for each interval
         for (var i = 0; i < pop.length; i++) {
             div.innerHTML +=
                 '' + getPokeball(pop[i] + 1) + "<strong>" +
                 pop[i] + "<br>" + "</strong>"
         }

         return div;
     };

     //Add and remove legend when layers are selected or not
     map.on('overlayadd', function(e) {
         if(e.name === "Cities") {
             cityLegend.addTo(map);
         }
     });

     map.on('overlayremove', function (e) {
         if(e.name === "Cities") {
             cityLegend.remove()
         }
     });

     map.on('zoomend', function() {
         //console.log("Zoom level: " + map.getZoom());
         var zoom = map.getZoom();
         if (zoom < 14 && (!lastZoom || lastZoom >= 14)) {
             map.eachLayer(function(l) {
                 if (l.getTooltip()) {
                     var tooltip = l.getTooltip();
                     if(tooltip.options.className != "labelRegion")  {
                        l.unbindTooltip().bindTooltip(tooltip, {
                            permanent: false
                        })
                     }
                 }
             })
         } else if (zoom >= 14 && (!lastZoom || lastZoom < 14)) {
             map.eachLayer(function(l) {
                 if (l.getTooltip()) {
                     var tooltip = l.getTooltip();
                     if(tooltip.options.className != "labelRegion")  {
                         l.unbindTooltip().bindTooltip(tooltip, {
                             permanent: true
                         })
                     }
                 }
             });
         }
         lastZoom = zoom;
     });

     //Next page
     $(".next_button").click(function(){
         $('.s'+currentStory+'_' + myStorage.getItem("s1_text")).hide();
         myStorage.setItem("s1_text", Number(myStorage.getItem("s1_text"))+1);
         $('.s'+currentStory+'_' + myStorage.getItem("s1_text")).show();
     });

     //Previous page
     $(".previous_button").click(function(){
         $('.s'+currentStory+'_' + myStorage.getItem("s1_text")).hide();
         myStorage.setItem("s1_text", Number(myStorage.getItem("s1_text"))-1);
         $('.s'+currentStory+'_' + myStorage.getItem("s1_text")).show();
     });

     //Close page
     $(".menu_button").click(function (event) {
         $('.story'+currentStory).click();
         controls.addTo(map);
     });

     //Reset stories
     $("#reset").click(function () {
         myStorage.clear();
     });

     //Story 1
     $(".story1").click(function () {
         if($(".story1").hasClass("active")) {
             removeOverlays(controls.getOverlays(), controls);
             controls.remove();
             currentStory = 1;
             startStory();
         } else {
             controls.addTo(map);
         }
     });

     //Story 2
     $(".story2").click(function () {
         if($(".story2").hasClass("active")) {
             controls.remove();
             currentStory = 2;
             startStory();
         } else {
             controls.addTo(map);
         }
     });

     function startStory() {
         if(! myStorage.getItem("s" + currentStory + "_text")) {
             myStorage.setItem("s" + currentStory + "_text", 1);
         }
         $('story' + currentStory + 'parent').children().hide();
         $('.s' + currentStory + '_' + myStorage.getItem("s" + currentStory + "_text")).show();
     }



     function removeOverlays(overlayArray, controlName) {
         for(var i = 0; i < overlayArray.length; i++) {
             overlayArray[i].layer.remove();
         }
         controlName.remove();
     }

     console.log(myStorage);

     ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
     //////                                                                                                       //////
     //////                                   FILE IMPORT/EXPORT                                                  //////
     //////                                                                                                       //////
     ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

     // Export layer to geojson-file for later use

     $("#export").click(function () {
         var name = $("#exportSelect").val();
         layer = getSelectedLayer(name);
         myStorage.setItem(name, JSON.stringify(layer.toGeoJSON()));
         download(name, JSON.stringify(layer.toGeoJSON()));
     });

     function download(filename, content) {
         var pom = document.createElement('a');
         pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
         pom.setAttribute('download', filename + ".geojson");
         pom.click();
     }

     $("#import").click(function() {
         var files = $("#fileImport").prop('files'); // FileList object

         // Loop through the FileList and render image files as thumbnails.
         for (var i = 0, f; f = files[i]; i++) {

             if(f.name.split(".").pop() != "geojson") {
                 continue;
             }

             var reader = new FileReader();

             // Closure to capture the file information.
             reader.onload = (function(theFile) {
                 return function(e) {
                     geojson = JSON.parse(e.target.result);
                     newLayer = L.layerGroup();
                     afterOperation(newLayer, geojson, theFile.name);
                 }
             })(f);

             // Read in the image file as a data URL.
             reader.readAsText(f);
         }
     });

     $("#fileImport").change(function(evt) {
         var files = evt.target.files; // FileList object

         // files is a FileList of File objects. List some properties.
         var output = [];

         for (var i = 0, f; f = files[i]; i++) {

             if(f.name.split(".").pop() != "geojson") {
                 continue;
             }

             output.push('<li><strong>', escape(f.name), '</strong> last modified: ',
                 f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
                 '</li>');
         }
         $("#import_list").html('<ul>' + output.join('') + '</ul>');
     });
     //document.getElementById('fileImport').addEventListener('change', handleFileSelect, false);

 </script>

</body>
</html>