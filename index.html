<!DOCTYPE html>
<html>
<head> 
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="lib/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <script src="js/sidenav.js"></script>
    <script src="js/fileLoad.js"></script>
    <script src="js/mapOperations.js"></script>


    <!-- Lib libraries -->
    <script src="lib/leaflet.js"></script> <!-- Leaflet osv basemap -->
    <script src="lib/leaflet.ajax.min.js"></script> <!-- Read external GeoJSON-files -->
    <script src="lib/jquery-3.3.1.min.js"></script> <!-- jQuery API -->
    <script src="lib/Sortable.min.js"></script> <!-- Sortable extension -->
    <script src="lib/turf.min.js"></script> <!-- Turf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script> <!-- Leaflet Draw Plugin -->
    <script src="js/leafletExtension.js"></script> <!-- Leaflet extension -->
    <link rel="stylesheet" href="index.css"/>
    <link rel="stylesheet" href="lib/tabMenu.css"/>
    <link rel="stylesheet" href="lib/stylesheet.css">
    <link rel="stylesheet" href="lib/leaflet.draw.css">
    <link rel="icon" href="pika.png">
    <title>PokéGIS</title>
</head>

<body>
<!-- Side navigation -->
<div class="sidenav">
    <img src="PokeGIS.png" alt="PokéGIS">
    <!-- Tab links -->
    <div id = "cssmenu" class="tab">
        <ul>
            <li id="defaultOpen" class="tablinks" onclick="openTab(event, 'Operations')"><a href="#">Operations</a></li>
            <li class="tablinks" onclick="openTab(event, 'Layers')"><a href="#">Layers</a></li>
            <li class="tablinks" onclick="openTab(event, 'Story')"><a href="#">Story</a></li>
        </ul>
    </div>

    <div id="Operations" class="tabcontent">
        <ul>
            <li>
                <div id="buffer" class="dropDown">Buffer</div>
                <div class="dropDownContent">
                    <span class="dropDownLeft">Layergroup:</span>
                    <select id="bufferLayerGroup" name="bufferSelect1" class="dropDownLayers dropDownLayerGroup" required>
                        <!-- Options here -->
                    </select>
                    <span class="dropDownLeft">Distance:</span>
                    <input name="bufferDistance" id="bufferDistance" type="number" placeholder="km">
                    <button id="createBuffer"
                            onclick="createBuffer('bufferLayerGroup','bufferDistance')">
                        Create buffer
                    </button>
                </div>
            </li>
            <li>
                <div id="Union" class="dropDown">Union</div>
                <div class="dropDownContent">
                    <span class="dropDownLeft">Layer1:</span>
                    <select id="unionLayerGroup1" name="unionSelect1" class="dropDownLayers dropDownLayerGroup" required>
                        <!-- Options here -->
                    </select>
                    <span class="dropDownLeft">Layer2:</span>
                    <select id="unionLayerGroup2" name="unionSelect2" class="dropDownLayers dropDownLayerGroup" required>
                        <!-- Options here -->
                    </select>
                    <button id="createUnion"
                        onclick="createUnion('unionLayerGroup1','unionLayerGroup2')">
                        Create union
                    </button>
                </div>
            </li>
            <li>
                <div id="Intersection" class="dropDown">Intersection</div>
                <div class="dropDownContent">
                    <span class="dropDownLeft">Layer1:</span>
                    <select id="intersectionLayerGroup1" name="intersectionSelect1" class="dropDownLayers dropDownLayerGroup" required>
                        <!-- Options here -->
                    </select>
                    <span class="dropDownLeft">Layer2:</span>
                    <select id="intersectionLayerGroup2" name="intersectionSelect2" class="dropDownLayers dropDownLayerGroup" required>
                        <!-- Options here -->
                    </select>
                    <button id="createIntersection"
                            onclick="createIntersection('intersectionLayerGroup1','intersectionLayerGroup2')">
                        Create intersection
                    </button>
                </div>

            </li>
            <li>
                <div id="Difference" class="dropDown">Difference</div>
                <div class="dropDownContent">
                    <span class="dropDownLeft">Layer:</span>
                    <select id="differenceLayerGroup1" name="differenceSelect1" class="dropDownLayers dropDownLayerGroup" required>
                        <!-- Options here -->
                    </select>
                    <span class="dropDownLeft">Diff. layer:</span>
                    <select id="differenceLayerGroup2" name="differenceSelect2" class="dropDownLayers dropDownLayerGroup" required>
                        <!-- Options here -->
                    </select>
                    <button id="createDifference"
                            onclick="createDifference('differenceLayerGroup1','differenceLayerGroup2')">
                        Create difference
                    </button>
                </div>

            </li>
            <li>
                <div id="Filter" class="dropDown">Filter</div>
                <div class="dropDownContent" id="filterDiv">
                    <span class="dropDownLeft">Layer:</span>
                    <select id="filterLayerGroup" class="dropDownLayers dropDownLayerGroup" required
                            onchange="updateFilterSelect('filterSelect','filterLayerGroup')">
                        <!-- Options here -->
                    </select>
                    <select id="filterSelect" required
                            onchange="updateFilterValue('filterDiv','filterLayerGroup','filterSelect')">
                        <!-- Options here -->
                    </select>
                    <select id="filterSign" required>
                        <!-- Option signs -->
                    </select>
                    <br id="break">
                    <button id="createFilter"
                            onclick="createFilter('filterLayerGroup','filterSelect','filterSign','filterValues')">
                        Extract features
                    </button>

                </div>
            </li>
            <li>
                <div style="border-bottom: 3px solid #FFCB05"></div>
            </li>
        </ul>
        <button class="resetButton" id="resetAll">Reset All</button>
    </div>

    <div id="Layers" class="tabcontent">
        <ul>
            <li>
                <div id="importHeader" class="dropDown">Import</div>
                <div class="dropDownContent">
                    <input id="fileImport" type="file" accept=".geojson" multiple>
                    <button id="import">Import geojson to map</button>
                </div>
            </li>
            <li>
                <div id="exportHeader" class="dropDown">Export</div>
                <div class="dropDownContent">
                    Layer:
                    <select id="exportSelect" class="dropDownLayers dropDownLayerGroup" required
                    <!-- Options here -->
                    </select>
                    <button id="export">Export layer to geojson</button>
                </div>
            </li>
            <li>
                <div id="styleHeader" class="dropDown">Style layers</div>
                <div class="dropDownContent">
                    <div id="style_layers">
                        <h4 style="text-align: center">Active layers appear here: <br></h4>
                        <!-- Layers here -->
                    </div>
                </div>
            </li>
        </ul>
        <div style="border-bottom: 3px solid #FFCB05"></div>
        <output id="import_list"></output>
        <div style="border-bottom: 3px solid #FFCB05"></div>

    </div>
    <div id="Story" class="tabcontent">
        <ul>
            <li>
                <div class="dropDown storyHeader story1">Story 1: The Basics</div>
                <div class="dropDownContent story1parent">
                    <div style="display: none" class="s1_1">
                        <h4>Hello there! Welcome to the world of pokémon. My name is Oak! People call me the pokémon Prof! This world is inhabited by creatures called pokémon! For some people, pokémon are pets. Others use them for fights. Myself...I study pokémon as a profession using GIS-tools to master it. <br><br> First we will have a look at the basics of GIS.</h4>
                        <button class="story_button next_button" style="float: right">Next Page</button>
                        <button class="story_button menu_button" style="float: right">Close Page</button>
                    </div>
                    <div style="display: none" class="s1_2">
                        <h4>Maps consist of different layers. Each layer can take up different forms; points, lines and polygons. <br><br> Now you will learn a little about each type of layer.</h4>
                        <img src="points.png" style="width: 230px; padding:0; margin: 0 27px 0 27px">
                        <button class="story_button previous_button">Prev Page</button>
                        <button class="story_button menu_button">Close Page</button>
                        <button id="s1_2n" class="story_button next_button">Next Page</button>
                    </div>
                    <div style="display: none" class="s1_3">
                        <h4>Now, you can see a point layer is added to the map. Points are single data values that can have data assigned to them.
                            This layer represents the cities of the region Kanto. Each city is represented by a pokeball. The balls are scaled with the size of the city, but not linear. It uses scaled circles, a logarithmic size expansion. <br>
                            Click on a city to get more information and find the population of Lavender Town.
                        </h4>
                        <input class="story_input" type="number" id="s1_pop" placeholder="population">
                        <button class="story_answer" id="s1_pop_ans">Check answer</button>
                        <button class="story_button previous_button">Prev Page</button>
                        <button class="story_button menu_button">Close Page</button>
                        <button id="s1_3n" class="story_button next_button locked">Next Page</button>
                    </div>
                    <div style="display: none" class="s1_4">
                        <h4>
                            Now we have added the roads in kanto to the map. The roads are represented by lines on the map. Each line consists of multiple points connected to each other. <br>
                        </h4>
                        <img src="line.png" style="width: 230px; padding:0; margin: 0 27px 0 27px">
                        <h4>
                            Click on the road between Viridian City and Pewter City to find the route number.
                        </h4>
                        <input class="story_input" type="number" id="s1_line" placeholder="route number">
                        <button class="story_answer" id="s1_line_ans">Check answer</button>
                        <button id="s1_4p" class="story_button previous_button">Prev Page</button>
                        <button class="story_button menu_button">Close Page</button>
                        <button id="s1_4n" class="story_button next_button locked">Next Page</button>
                    </div>
                    <div style="display: none" class="s1_5">
                        <h4>
                            The last type of layers we will have a look at are polygons. Polygons are closed loop of lines. <br>
                        </h4>
                        <img src="polygon.png" style="width: 230px; padding:0; margin: 0 27px 0 27px">
                        <h4>
                            Your task is to find out how many islands the region of Hoenn are made up of. Hover or click a region to get more information about it.

                        </h4>
                        <input class="story_input" type="number" id="s1_pol" placeholder="number of islands">
                        <button class="story_answer" id="s1_pol_ans">Check answer</button>
                        <button id="s1_5p" class="story_button previous_button">Prev Page</button>
                        <button class="story_button menu_button">Close Page</button>
                        <button id="s1_5n" class="story_button next_button locked">Next Page</button>
                    </div>
                    <div style="display: none" class="s1_6">
                        <h4>
                            Congratulations! You have now finished your first story line. You can now go on to the buffer story.
                        </h4>
                        <button class="story_button previous_button">Prev Page</button>
                        <button class="story_button menu_button">Close Page</button>
                    </div>
                </div>
            </li>
            <li>
                <div class="dropDown storyHeader story2 locked">Story2: Buffer</div>
                <div class="dropDownContent">
                    <div style="display: none" class="s2_1">
                        <h4>
                            You have started your pokémon adventure and reached Viridian City. Trying to buy pokéballs at the Poké Mart, the clerk gives you a parcel. A note on the parcel says: <br>"To be delivered to Professor Oak in Pallet Town" <br>
                        </h4>
                        <button class="story_button next_button" style="float: right">Next Page</button>
                        <button class="story_button menu_button" style="float: right">Close Page</button>
                    </div>
                    <div style="display: none" class="s2_2">
                        <h4>
                            It is starting to get dark and you know powerful pokémon sneak around in the grass after sunset. Worried about encountering one you decide to start the walk to Pallet Town, only if it is less than 6 km to walk.
                            A buffer can give you the answer to this. Use the buffer tool in the operations tab to construct a buffer around Viridian City.
                        </h4>
                        <img src="buffer_point.png" style="width: 50px; margin: 0 116px 0 116px">
                        <button class="story_button previous_button">Prev Page</button>
                        <button class="story_button menu_button">Close Page</button>
                        <button id="s2_2n" class="story_button next_button">Next Page</button>
                    </div>
                    <div style="display: none" class="s2_3">
                        <h4>
                            Use the buffer tool in the operations tab to construct a buffer around Viridian City with distance 6 km.
                        </h4>
                        <img src="buffer_point.png" style="width: 50px; margin: 0 116px 0 116px">
                        <h4>Is Pallet Town within 6 km from Viridian City? </h4>
                        <select id="s2_buf_point" style="display: block; float: left; margin: 0 74px 0 73px">
                            <option disabled="disabled" selected>-- Select answer --</option>
                            <option value="false">Yes</option>
                            <option value="true">No</option>
                        </select>
                        <button class="story_button previous_button">Prev Page</button>
                        <button class="story_button menu_button">Close Page</button>
                        <button id="s2_3n" class="story_button next_button locked">Next Page</button>
                    </div>
                    <div style="display: none" class="s2_4">
                        <button id="s2_4p" class="story_button previous_button">Prev Page</button>
                        <button class="story_button menu_button">Close Page</button>
                        <button id="s2_4n" class="story_button next_button locked">Next Page</button>
                    </div>
                </div>
            </li>
            <li>
                <div class="dropDown storyHeader story3 locked">Story3</div>
                <div class="dropDownContent">

                </div>

            </li>
            <li>
                <div class="dropDown storyHeader story4 locked">Story4</div>
                <div class="dropDownContent">

                </div>

            </li>
            <li>
                <div class="dropDown storyHeader story5 locked">Story5</div>
                <div class="dropDownContent"></div>
            </li>
            <li>
                <div style="border-bottom: 3px solid #FFCB05"></div>
            </li>
        </ul>
        <button class="resetButton" id="reset">Reset stories</button>
    </div>

</div>

<!-- Page content -->
<div class="main">
    <div id="map"></div>
</div>
 <script type="text/javascript">

     document.getElementById("defaultOpen").click();

     myStorage = window.localStorage;
     console.log(myStorage);
     if(! myStorage.getItem('storyIndex')) {
         myStorage.setItem('storyIndex', 1);
     }

     var storyIndex = myStorage.getItem('storyIndex');

     // Set background map
     var map = L.map('map', {
         //drawControl: true,
         minZoom: 11,
         maxZoom: 20
     }).setView([63.366288, 10.4308315]);

     ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
     //////                                                                                                       //////
     //////                            Leaflet.draw                                                               //////
     //////                                                                                                       //////
     ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

     // FeatureGroup is to store editable layers
     var editableLayers = new L.FeatureGroup();
     map.addLayer(editableLayers);
     editableLayers.addTo(map);
     var drawControl = new L.Control.Draw({
         edit: {
             featureGroup: editableLayers
         }
     });
     map.addControl(drawControl);

     //Set bounds for startup
     var startBounds = L.latLngBounds([
         [63.381063, 10.393066],
         [63.351513, 10.468597]
     ]);

     //Set bounds for panning
     var worldBounds = L.latLngBounds([
         [63.430860, 10.055237],
         [63.171095, 10.784454]
     ]);

     //Start and panning bounds applied
     map.fitBounds(startBounds);
     map.on('drag', function() {
         map.panInsideBounds(worldBounds, { animate: true });
     });

     lastZoom = map.getZoom();
     //Add baseMap layer to map and display it
     var backGroundLayer = L.layerGroup().addTo(map);

     var baseLayer = {
         "Pokemon World": backGroundLayer
     };

     var overlay = {};

     var controls = L.control.layers(baseLayer, overlay, {collapsed:false}).addTo(map);

     //Add a region layer to map
     var politicalLayer = L.layerGroup();

     //Make a region dictionary and collect in featureGroups
     var regions = {};
     regionNames = ["Hoenn", "Sinnoh", "Orange Islands", "Orre", "Johto", "Kanto", "Sevii Islands", "Fiore", "Oblivia", "Almia", "Holon", "Unova", "Distant land", "Rest"];
     for (var i = 0; i < regionNames.length; i++) {
         regions[regionNames[i]] = L.featureGroup();
         politicalLayer.addLayer(regions[regionNames[i]]);
     }

     //Make a layer for all cities on the map
     var cityLayer = L.layerGroup();

     var cities = {};

     //Add hightlighting on hover
     politicalLayer.eachLayer(function (layer) {
        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight
        });
     });


     loadBackgroundData();
     loadOverlayData();

     controls.addOverlay(politicalLayer, "Geographical region");
     controls.addOverlay(cityLayer, "Cities");

     updateLayerGroup();

     addDropdown();

     function getPokeball(pop) {
         var size = Math.pow(Math.E, 0.57*(Math.log(pop)-Math.log(0.1))) < 10 ? 10 : Math.pow(Math.E, 0.57*(Math.log(pop)-Math.log(0.1)));
         if (size < 200) {
             return "<img src=pokeball.png width=" + size + " height=" + size + " style: {margin: 10px}>";
         } else {
             return "<img src=pokeball.png width=10 height=10 style: {margin: 10px}>";
         }
     }

     var cityLegend = L.control({position: 'bottomright'});

     cityLegend.onAdd = function(map) {
         var div = L.DomUtil.create('div', 'info legend'),
             pop = [25, 50, 75, 100],
             labels = [];

         div.innerHTML += "<strong>Population: </strong><br><br>";
         // loop through our density intervals and generate a icon for each interval
         for (var i = 0; i < pop.length; i++) {
             div.innerHTML +=
                 '' + getPokeball(pop[i] + 1) + "<strong>" +
                 pop[i] + "<br>" + "</strong>"
         }

         return div;
     };

     //Add and remove legend when layers are selected or not
     map.on('overlayadd', function(e) {
         if(e.name === "Cities") {
             cityLegend.addTo(map);
         }
         $("#style_layers").append(function () {
             return "<li><div class='style_layer-item'><input class='input_color' id='" + e.name.split(' ')[0] + "' type='color'><h4>" + e.name + "</h4></div></li>";
         });
         id = "#" + e.name.split(' ')[0];
         $(id).data(e.name, e.layer);
         $(id).change(function (e) {
             var layer = $(id).data();
             var color = e.target.value;
             /*
             for(var key in layer) {
                 console.log(layer[key]);
                 layer[key]._layers.forEach(function (l) {
                     l.setStyle({"fillColor": color})
                 });
             }*/

             // find some way to change color
         });
     });

     map.on('overlayremove', function (e) {
         if(e.name === "Cities") {
             cityLegend.remove()
         }
         $("#" + e.name.split(' ')[0]).parent().parent().remove();

     });

     map.on('zoomend', function() {
         //console.log("Zoom level: " + map.getZoom());
         var zoom = map.getZoom();
         if (zoom < 14 && (!lastZoom || lastZoom >= 14)) {
             map.eachLayer(function(l) {
                 if (l.getTooltip()) {
                     var tooltip = l.getTooltip();
                     if(tooltip.options.className != "labelRegion")  {
                        l.unbindTooltip().bindTooltip(tooltip, {
                            permanent: false
                        })
                     }
                 }
             })
         } else if (zoom >= 14 && (!lastZoom || lastZoom < 14)) {
             map.eachLayer(function(l) {
                 if (l.getTooltip()) {
                     var tooltip = l.getTooltip();
                     if(tooltip.options.className != "labelRegion")  {
                         l.unbindTooltip().bindTooltip(tooltip, {
                             permanent: true
                         })
                     }
                 }
             });
         }
         lastZoom = zoom;
     });

     /*
     map.on('click', function(event) {
         console.log(event.latlng);
     });*/

     if(! myStorage.getItem('drawId')) {
         myStorage.setItem('drawId', 1);
     }
     var id = myStorage.getItem("drawId");

     controls.addOverlay(editableLayers, "Edit_" + myStorage.getItem("drawId"));
     updateLayerGroup();

     map.on(L.Draw.Event.CREATED, function (e) {
         var type = e.layerType,
             layer = e.layer,
             feature = layer.feature = layer.feature || {}; //Initialize feature
         var props = feature.properties = feature.properties || {}; // Initialize feature.properties
         feature.type = "Feature";
         layer.bindPopup(function (layer) {
             string = "<div>";
             for (var key in props) {
                if(key == "name" || key == "Name") {
                    string +="<br><strong>" + props[key] + "</strong><hr>";
                }
             }
             for (var key in props) {
                 if(key != "name" && key != "Name") {
                     string += "<br><strong>" + key + ":</strong> " + props[key];
                 }
             }
             string += "<hr><strong>Add feature properties: </strong><br>";
             string += "<input type='text' placeholder='Property name' id='p_" + L.Util.stamp(layer) + "' class='popupInput'>";
             string += "<input type='text' placeholder='Value' id='v_" + L.Util.stamp(layer) + "' class='popupInput'>";
             string += "<button class='popupButton' onclick='popupForm(" + L.Util.stamp(layer) + ")'>Submit</button>";
             string += "<br><br><br><br></div>";
             return string;
         });
         editableLayers.addLayer(layer);

     });

     function popupForm(layerId) {
         layer = editableLayers.getLayer(layerId);
         var valueField, propertyField;
         valueField = document.getElementById("v_" + layerId).value;
         propertyField = document.getElementById("p_" + layerId).value;
         layer.feature.properties[propertyField] = valueField;
         layer.getPopup().update();
     }

     //Reset storage
     $("#resetAll").click(function () {
         myStorage.clear();
     });


     ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
     //////                                                                                                       //////
     //////                                     LOAD LAYERS                                                       //////
     //////                                                                                                       //////
     ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
     var cityKantoLayer = L.layerGroup();
     jQuery.getJSON("data/CitiesKanto.geojson", function (json) {
         L.geoJSON(json, {
             pointToLayer: function (feature, latlng) {
                 var pop = feature.properties.Population;
                 var size = Math.pow(Math.E, 0.57*(Math.log(pop)-Math.log(0.1))) < 10 ? 10 : Math.pow(Math.E, 0.57*(Math.log(pop)-Math.log(0.1)));
                 var pokeball = new PokeIcon({
                     iconSize: [size,size],
                     iconAnchor: [size/2, size/2],
                     popupAnchor: [0, -size/2]
                 });
                 return L.marker(latlng, {icon: pokeball});

             },
             onEachFeature: function (feature, layer) {
                 cityKantoLayer.addLayer(layer);
                 layer.bindPopup(function(layer) {
                     return "<strong><u>" + layer.feature.properties.Name + "</strong></u>" +
                         "<br><strong>Region:</strong> " + layer.feature.properties.Region +
                         "<br><strong>Population: </strong>" + layer.feature.properties.Population +
                         "<br><strong>Description: </strong>" + layer.feature.properties.Description
                 });
                 layer.bindTooltip(function (layer) {
                     return layer.feature.properties.Name;
                 }, {
                     permanent:true,
                     direction: "center",
                     offset: L.point({x: 0, y: 40}),
                     className: 'label',
                     opacity: 0.9
                 }).openTooltip();
             }
         });
     });

     var roadLayer = L.layerGroup();
     jQuery.getJSON("data/roads.geojson", function (json) {
         L.geoJSON(json, {
             style: function (feature) {
                 return {
                     "stroke": true,
                     "weight": 5,
                     "color": "#000000"
                 };
             },
             onEachFeature: function (feature, layer) {
                 if(feature.properties.type == "route") {
                     roadLayer.addLayer(layer);
                     layer.bindPopup(function(layer) {
                         return "<strong>" + layer.feature.properties.type +
                             layer.feature.properties.number + "</strong>"
                     });
                 }
             }
         });
     });

     var viridianCity = L.layerGroup();
     jQuery.getJSON("data/Viridian_City.geojson", function (json) {
         L.geoJSON(json, {
             pointToLayer: function(feature, latlng) {
                 return L.circleMarker(latlng);
             },

             onEachFeature: function (feature, layer) {
                 viridianCity.addLayer(layer);
             }
         });
     });


     ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
     //////                                                                                                       //////
     //////                                         STORIES                                                       //////
     //////                                                                                                       //////
     ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

     var removeArray = [], addArray;

     // Disable locked buttons
     $(".locked").attr("disabled", "disabled");

     // Set css for locked stories
     for(var i = Number(myStorage.getItem("storyIndex")) + 1; i < 6; i++) {
         string = ".story" + i;
         $(string).css("filter", "brightness(50%)");
         $(string).css("pointer-events", "none");
     }

     //Next page
     $(".next_button").click(function(){
         $('.s'+currentStory+'_' + myStorage.getItem("s" + currentStory + "_text")).hide();
         myStorage.setItem("s" + currentStory + "_text", Number(myStorage.getItem("s" + currentStory + "_text"))+1);
         $('.s'+currentStory+'_' + myStorage.getItem("s" + currentStory + "_text")).show();
         removeOverlays(removeArray, controls);
     });

     //Previous page
     $(".previous_button").click(function(){
         $('.s'+currentStory+'_' + myStorage.getItem("s" + currentStory + "_text")).hide();
         myStorage.setItem("s" + currentStory + "_text", Number(myStorage.getItem("s" + currentStory + "_text"))-1);
         $('.s'+currentStory+'_' + myStorage.getItem("s" + currentStory + "_text")).show();
         removeOverlays(removeArray, controls);
     });

     //Close page
     $(".menu_button").click(function () {
         $('.story'+currentStory).click();
         $('.s'+currentStory+'_' + myStorage.getItem("s" + currentStory + "_text")).hide();
         removeOverlays(removeArray, controls);
         addOverlaysFromArray(addArray, controls);
     });

     //Reset stories
     $("#reset").click(function () {
         for(var i = 1; i <= Number(myStorage.getItem("storyIndex")) + 1; i++ ) {
             myStorage.setItem("s" + i + "_text", 1);
         }
         myStorage.setItem("storyIndex", 2);
         for(var i = 2; i < 6; i++) {
             string = ".story" + i;
             $(string).css("filter", "brightness(50%)");
             $(string).css("pointer-events", "none");
         }
     });

     //Story 1
     $(".story1").click(function () {
         currentStory = 1;
         if($(".story1").hasClass("active")) {
             addArray = controls.getOverlays();
             removeOverlays(controls.getOverlays(), controls);
             startStory();
         } else {
             removeOverlays(removeArray, controls);
             $('.s'+currentStory+'_' + myStorage.getItem("s" + currentStory + "_text")).hide();
             addOverlaysFromArray(addArray, controls);
         }
     });


     $("#s1_2n, #s1_4p").click(function () {
         cityKantoLayer.addTo(map);
         cityLegend.addTo(map);
         controls.addOverlay(cityKantoLayer, "Cities_Kanto");
         removeArray.push(cityKantoLayer);
         removeArray.push(cityLegend);
     });

     /*
     $('#s1_pop_ans').click(function(){
         var number = $('#s1_pop').val();
         if(number == 41) {
             alert("Correct!");
             $('#s1_3n').removeClass("locked");
             $('#s1_3n').attr("disabled", false);
         } else {
             alert("Shoot! It was so close too!")
         }
     });


     $("#s1_3n, #s1_5p").click(function () {
         //var c = L.control.layers(null, {"cities": cityKantoLayer}, {collapsed: false}).addTo(map);
         roadLayer.addTo(map);
         map.fitBounds([
             [63.38237, 10.37658],
             [63.34820, 10.47889]
         ]);
         removeArray.push(roadLayer);
     });


     $('#s1_line_ans').click(function(){
         var number = $('#s1_line').val();
         if(number == 2) {
             alert("Correct!");
             $('#s1_4n').removeClass("locked");
             $('#s1_4n').attr("disabled", false);
         } else {
         alert("Shoot! It was so close too!")
         }
     });

     $("#s1_4n, #s1_6p").click(function () {
         while (removeArray.length > 0) {
             removeArray.pop().remove();
         }
         politicalLayer.addTo(map);
         map.setZoom(11);
         map.setView([63.28861, 10.38139]);
         removeArray.push(politicalLayer);
     });

     $('#s1_pol_ans').click(function(){
         var number = $('#s1_pol').val();
         if(number == 11) {
             alert("Correct!");
             $('.story2').removeClass("locked");
             $(".story2").css("pointer-events", "");
             $(".story2").css("filter", "brightness(100%)");
             $('#s1_5n').removeClass("locked");
             $('#s1_5n').attr("disabled", false);
             myStorage.setItem("storyIndex", 2);
         } else {
             alert("Shoot! It was so close too!")
         }
     });


     //Story 2
     $(".story2").click(function () {
         currentStory = 2;
         if($(".story2").hasClass("active")) {
             controls.remove();
             startStory();
             cityKantoLayer.addTo(map);
             removeArray.push(cityKantoLayer);
         } else {
             removeOverlays(removeArray, controls);
             $('.s'+currentStory+'_' + myStorage.getItem("s" + currentStory + "_text")).hide();
             controls.addOverlay(politicalLayer, "Geographical region");
             controls.addOverlay(cityLayer, "Cities");
         }
     });

     $("#s2_2n, #s2_4p").click(function() {
         cityKantoLayer.addTo(map);
         viridianCity.addTo(map);
         controls.addOverlay(cityKantoLayer, "Cities_Kanto");
         controls.addOverlay(viridianCity, "Viridian_City");
         updateLayerGroup();
         var control2 = L.control.layers(null, {
             "Cities Kanto": cityKantoLayer,
             "Viridian City": viridianCity},
             {collapsed: false}).addTo(map);
         removeArray.push(cityKantoLayer);
         removeArray.push(viridianCity);
         removeArray.push(control2);
     });

     $("#s2_buf_point").change(function(){
         if($("#s2_buf_point").val()) {
             alert("Correct!");
             $("#s2_3n").removeClass("locked");
             $('#s2_3n').attr("disabled", false);
         } else {
             alert("Shoot! It was so close too!");
         }
     });

     $("#s2_3n, s2_5p").click(function() {

     });


*/


     function startStory() {
         if(! myStorage.getItem("s" + currentStory + "_text")) {
             myStorage.setItem("s" + currentStory + "_text", 1);
         }
         $('story' + currentStory + 'parent').children().hide();
         $('.s' + currentStory + '_' + myStorage.getItem("s" + currentStory + "_text")).show();
         if($("#s" + currentStory + "_" + (Number(myStorage.getItem("s" + currentStory + "_text"))-1) + "n").length) {
             $("#s" + currentStory + "_" + (Number(myStorage.getItem("s" + currentStory + "_text"))-1) + "n").click();
         }
         map.fitBounds([
             [63.38237, 10.37658],
             [63.34820, 10.47889]
         ]);
     }



     function removeOverlays(arr, con) {
         while(arr.length > 0 ) {
             lay = arr.pop().layer;
             con.removeLayer(lay);
             lay.remove();
         }
     }

     function addOverlaysFromArray(arr, con) {
         while(arr.length > 0 ) {
             lay = arr.pop();
             con.addOverlay(lay.layer, lay.name);
         }
     }

     ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
     //////                                                                                                       //////
     //////                                   FILE IMPORT/EXPORT                                                  //////
     //////                                                                                                       //////
     ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

     // Export layer to geojson-file for later use

     $("#export").click(function () {
         var name = $("#exportSelect").val();
         layer = getSelectedLayer(name);
         myStorage.setItem(name, JSON.stringify(layer.toGeoJSON()));
         download(name, JSON.stringify(layer.toGeoJSON()));
     });

     function download(filename, content) {
         var pom = document.createElement('a');
         pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
         pom.setAttribute('download', filename + ".geojson");
         pom.click();
     }

     $("#import").click(function() {
         var files = $("#fileImport").prop('files'); // FileList object

         // Loop through the FileList and render image files as thumbnails.
         for (var i = 0, f; f = files[i]; i++) {

             if(f.name.split(".").pop() != "geojson") {
                 continue;
             }

             var reader = new FileReader();

             // Closure to capture the file information.
             reader.onload = (function(theFile) {
                 return function(e) {
                     geojson = JSON.parse(e.target.result);
                     newLayer = L.layerGroup().addTo(map);
                     if(geojson.features[0].geometry.type == "Point") {
                         var color = "#" + Math.floor(Math.random()*16777216).toString(16);
                         L.geoJSON(geojson, {
                             pointToLayer: function (feature, latlng) {
                                 return L.circleMarker(latlng, {
                                     "radius": 10,
                                     "stroke": true,
                                     "weight": 1,
                                     "color": "#000000",
                                     "fill": true,
                                     "fillColor": color,
                                     "fillOpacity": 0.9
                                 });
                             },
                             onEachFeature: function(feature, layer) {
                                 res = "<strong>Layer: <u>" + theFile.name + "</u></strong><br>";
                                 for(var key in feature.properties) {
                                     res = res.concat("<strong>", key, ": </strong>",  feature.properties[key],"<br>");
                                 }
                                layer.bindPopup(function(layer) {
                                    return res;
                                });
                                 newLayer.addLayer(layer);
                             }
                         });
                         overlay[theFile.name] = newLayer;
                         newLayer.eachLayer(function (layer) {
                             layer.on({
                                 mouseover: highlightFeature,
                                 mouseout: resetHighlight
                             });
                         });
                         controls.addOverlay(newLayer, theFile.name);
                         updateLayerGroup();
                     } else {
                         afterOperation(newLayer, geojson, theFile.name);
                     }
                 }
             })(f);

             // Read in the image file as a data URL.
             reader.readAsText(f);
         }
     });

     $("#fileImport").change(function(evt) {
         var files = evt.target.files; // FileList object

         // files is a FileList of File objects. List some properties.
         var output = [];

         for (var i = 0, f; f = files[i]; i++) {

             if(f.name.split(".").pop() != "geojson") {
                 continue;
             }

             output.push('<li><strong>', escape(f.name), '</strong> last modified: ',
                 f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
                 '</li>');
         }
         $("#import_list").html('<ul>' + output.join('') + '</ul>');
     });


     ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
     //////                                                                                                       //////
     //////                                   JQUERY EXTENSION                                                    //////
     //////                                                                                                       //////
     ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

     (function ($) {
         var _oldShow = $.fn.show;

         $.fn.show = function (/*speed, easing, callback*/) {
             var argsArray = Array.prototype.slice.call(arguments),
                 duration = argsArray[0],
                 easing,
                 callback,
                 callbackArgIndex;

             // jQuery recursively calls show sometimes; we shouldn't
             //  handle such situations. Pass it to original show method.
             if (!this.selector) {
                 _oldShow.apply(this, argsArray);
                 return this;
             }

             if (argsArray.length === 2) {
                 if ($.isFunction(argsArray[1])) {
                     callback = argsArray[1];
                     callbackArgIndex = 1;
                 } else {
                     easing = argsArray[1];
                 }
             } else if (argsArray.length === 3) {
                 easing = argsArray[1];
                 callback = argsArray[2];
                 callbackArgIndex = 2;
             }

             return $(this).each(function () {
                 var obj = $(this),
                     oldCallback = callback,
                     newCallback = function () {
                         if ($.isFunction(oldCallback)) {
                             oldCallback.apply(obj);
                         }

                         obj.trigger('afterShow');
                     };

                 if (callback) {
                     argsArray[callbackArgIndex] = newCallback;
                 } else {
                     argsArray.push(newCallback);
                 }

                 obj.trigger('beforeShow');

                 _oldShow.apply(obj, argsArray);
             });
         };
     })(jQuery);

 </script>

</body>
</html>